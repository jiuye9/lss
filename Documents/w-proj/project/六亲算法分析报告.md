# 六爻排盘六亲算法分析报告

## 1. 问题发现

### 当前算法的错误实现

当前代码中的六亲计算存在**根本性错误**，具体表现为：

```javascript
// ❌ 错误的实现逻辑（当前代码第2513-2531行）
function calculateLiuQin(hexBinary, dayGan, najiaGanZhi) {
    const result = [];
    const dayGanWuxing = WUXING[dayGan];  // 错误：使用日干五行

    for (let i = 0; i < 6; i++) {
        const najiaStr = najiaGanZhi[i];
        const najiaGan = najiaStr.charAt(0);  // 错误：使用纳甲天干
        const najiaGanWuxing = WUXING[najiaGan];

        // 错误：基于纳甲天干与日干的关系判断六亲
        const liuQin = getLiuQinRelation(dayGanWuxing, najiaGanWuxing, najiaGan, dayGan);
        result.push(liuQin);
    }
    return result;
}
```

### 错误分析

1. **理论基础错误**：使用"纳甲天干与日干的关系"而不是"纳支与卦宫的关系"
2. **依赖日干**：六亲计算不应依赖起卦日期的日干
3. **忽略卦宫**：完全没有考虑卦宫五行的作用
4. **违背传统**：背离了"地支跟卦走，卦宫定六亲"的基本原理

## 2. 传统理论："地支跟卦走，卦宫定六亲"

### 核心概念

**"地支跟卦走"**：
- 每个卦象的纳支（地支）是固定的
- 由卦象本身决定，不随外界因素变化
- 体现了卦象内在的五行结构

**"卦宫定六亲"**：
- 六亲关系由纳支的五行与卦宫五行的关系决定
- 卦宫是该卦所属的八个基本卦之一（乾、坤、震、巽、坎、离、艮、兑）
- 不依赖起卦时间的干支

### 八卦卦宫五行

| 卦宫 | 五行 | 包含卦象 |
|------|------|----------|
| 乾宫 | 金 | 乾为天、天风姤、天山遁、天地否、风天小畜、山天大畜、火天大有、地天泰 |
| 坤宫 | 土 | 坤为地、地雷复、地泽临、地天泰、雷地豫、泽地萃、火地晋、天地否 |
| 震宫 | 木 | 震为雷、雷地豫、雷水解、雷风恒、地雷复、水雷屯、山雷颐、风雷益 |
| 巽宫 | 木 | 巽为风、风天小畜、风火家人、风雷益、天风姤、火风鼎、山风蛊、地风升 |
| 坎宫 | 水 | 坎为水、水泽节、水雷屯、水火既济、泽水困、雷水解、山水蒙、地水师 |
| 离宫 | 火 | 离为火、火山旅、火风鼎、火水未济、山火贲、风火家人、雷火丰、水火既济 |
| 艮宫 | 土 | 艮为山、山火贲、山天大畜、山泽损、火山旅、天山遁、水山蒙、地山谦 |
| 兑宫 | 金 | 兑为泽、泽水困、泽地萃、泽山咸、水泽节、地泽临、火泽睽、山泽损 |

### 五行生克与六亲关系

基于五行生克理论：

| 关系 | 六亲 | 说明 |
|------|------|------|
| 我生者 | 子孙 | 卦宫五行生纳支五行 |
| 生我者 | 父母 | 纳支五行生卦宫五行 |
| 我克者 | 妻财 | 卦宫五行克纳支五行 |
| 克我者 | 官鬼 | 纳支五行克卦宫五行 |
| 比和者 | 兄弟 | 纳支五行与卦宫五行相同 |

## 3. 正确算法实现

### 核心函数

```javascript
function calculateCorrectLiuQin(hexBinary, nazhiList) {
    // 1. 获取卦宫
    const hexInfo = getHexagramInfo(hexBinary);
    const guaGong = hexInfo.palace;  // 卦宫名称

    // 2. 获取卦宫五行
    const guaGongWuxing = BAGUA_WUXING[guaGong];

    // 3. 计算每一爻的六亲
    const liuqinList = [];
    for (let i = 0; i < 6; i++) {
        const nazhi = nazhiList[i];           // 该爻的纳支
        const nazhiWuxing = DIZHI_WUXING[nazhi];  // 纳支五行

        // 根据纳支五行与卦宫五行的关系确定六亲
        const liuqin = LIUQIN_RELATIONS[guaGongWuxing][nazhiWuxing];
        liuqinList.push(liuqin);
    }

    return liuqinList;
}
```

### 配置表

```javascript
// 八卦五行对照
const BAGUA_WUXING = {
    '乾': '金', '兑': '金',     // 乾兑属金
    '离': '火',                 // 离属火
    '震': '木', '巽': '木',     // 震巽属木
    '坎': '水',                 // 坎属水
    '艮': '土', '坤': '土'      // 艮坤属土
};

// 地支五行对照
const DIZHI_WUXING = {
    '子': '水', '亥': '水',
    '寅': '木', '卯': '木',
    '巳': '火', '午': '火',
    '申': '金', '酉': '金',
    '丑': '土', '辰': '土', '未': '土', '戌': '土'
};
```

## 4. 实例验证

### 乾为天卦示例

**卦象信息**：
- 二进制：111111
- 卦名：乾为天
- 卦宫：乾宫（属金）
- 纳支：子、寅、辰、午、申、戌

**六亲计算**：

| 爻位 | 纳支 | 纳支五行 | 与卦宫关系 | 六亲 |
|------|------|----------|------------|------|
| 初爻 | 子 | 水 | 金生水（我生） | 子孙 |
| 二爻 | 寅 | 木 | 金克木（我克） | 妻财 |
| 三爻 | 辰 | 土 | 土生金（生我） | 父母 |
| 四爻 | 午 | 火 | 火克金（克我） | 官鬼 |
| 五爻 | 申 | 金 | 金见金（比和） | 兄弟 |
| 上爻 | 戌 | 土 | 土生金（生我） | 父母 |

**结果**：子孙、妻财、父母、官鬼、兄弟、父母

## 5. 算法对比

### 错误算法 vs 正确算法

| 方面 | 错误算法（当前代码） | 正确算法（传统方法） |
|------|----------------------|----------------------|
| **理论基础** | 纳甲天干与日干关系 | 纳支与卦宫关系 |
| **依赖因素** | 起卦日期的日干 | 卦象本身 |
| **计算要素** | 天干五行、阴阳同性 | 地支五行、卦宫五行 |
| **传统符合性** | 违背传统理论 | 符合传统理论 |
| **稳定性** | 同一卦不同日期结果不同 | 同一卦结果固定 |

### 具体差异示例

**同一个卦象（乾为天）在不同算法下的结果**：

**错误算法**：
- 戊戌日：基于戊（土）与纳甲天干的关系
- 甲子日：基于甲（木）与纳甲天干的关系
- **结果不一致** ❌

**正确算法**：
- 任何日期：基于卦宫乾（金）与纳支的关系
- **结果始终一致** ✅

## 6. 修正建议

### 立即修正

1. **替换计算函数**：
   ```javascript
   // 替换现有的 calculateLiuQin 函数
   function calculateLiuQin(hexBinary, dayGan, najiaGanZhi) {
       // 获取纳支（地支部分）
       const nazhiList = najiaGanZhi.map(gz => gz.charAt(1));

       // 使用正确的算法
       return calculateCorrectLiuQin(hexBinary, nazhiList);
   }
   ```

2. **更新配置数据**：
   - 添加正确的八卦五行对照表
   - 添加正确的地支五行对照表
   - 添加正确的六亲关系对照表

3. **移除错误逻辑**：
   - 删除基于日干的计算逻辑
   - 删除阴阳同性判断逻辑
   - 删除复杂的五行关系映射表

### 长期改进

1. **理论学习**：深入学习传统六爻理论
2. **算法验证**：对照经典六爻书籍验证算法
3. **测试用例**：建立完整的测试用例库
4. **文档完善**：添加算法说明和理论依据

## 7. 结论

当前六亲计算算法存在根本性错误，违背了传统六爻"地支跟卦走，卦宫定六亲"的核心理论。正确的算法应该：

1. **以卦宫五行为基准**：不依赖起卦日期
2. **以纳支五行为变量**：考虑每爻的地支属性
3. **以生克关系定六亲**：按照我生子孙、生我父母、我克妻财、克我官鬼、比和兄弟的原则

修正后的算法将更加符合传统理论，计算结果也将更加准确和稳定。

---

*报告完成时间：2025年9月26日*
*分析对象：六爻排盘系统六亲计算算法*