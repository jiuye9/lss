一、项目背景与目标

背景：面向占筮应用（网页/小程序/桌面）的“六爻排盘”核心引擎与UI组件，满足用户根据起卦信息快速生成完整卦盘，自动标注六亲、六神、世应、动爻、伏神、月建日辰、神煞等，并提供导出与分享。
目标：
实现标准化的六爻排盘算法，保证与主流排盘一致性；
支持多种起卦方式（时间起卦、报数/掷钱、手动指定）；
输出结构化数据与可视化排盘；
具备可测试、可扩展的架构。
二、术语与约定

本卦：由上卦、下卦构成的六爻卦。
互卦：由本卦二三四爻组成下卦、三四五爻组成上卦的派生卦。
变卦：本卦中动爻变爻后形成的卦。
世爻、应爻：六爻中标出“世”“应”的两爻，定位关系用于占断。
六亲：兄弟、子孙、妻财、官鬼、父母，根据日干支相对五行生克与卦爻五行推导。
六神：青龙、朱雀、勾陈、腾蛇、白虎、玄武，按起例随日或固定轮转排布。
伏神：当一爻缺所需六亲时，根据地支藏干或纳甲体系附在对应爻下。
月建/日辰：起卦所用农历月令与当日干支。
纳甲：将天干地支配入八卦爻位的规则（常用京房纳甲体系）。
三、功能范围

起卦输入
支持方式： a. 时间起卦：输入公历/农历时间，自动换算为干支（年/月/日/时），并据此定月建、日辰； b. 掷钱/报数起卦：输入三次或六次掷钱结果或报数，生成六爻阴阳与动静； c. 手动指定：直接选择上卦、下卦、动爻集。
校验：时间合法性、掷钱序列长度、动爻范围（1-6）等。
排盘输出
生成项： a. 本卦：六爻阴阳、上/下卦名、总卦名、纳甲地支、爻位干支； b. 世应：按卦所属的宫定世应位置； c. 六亲：基于日干与卦爻五行的生克关系标注； d. 六神：按当日或规则轮转依次标注于六爻； e. 动爻：标注动爻并生成变卦；多动爻时全部变动； f. 互卦：自动计算互卦； g. 伏神：在缺位时，根据规则安伏； h. 月建/日辰：显示农历月令、当日干支； i. 神煞（可选）：旬空、驿马、桃花、贵人等（可开关）。
展示形式：
列表式六爻自下而上显示：每爻包含 位置(初/二/三/四/五/上)、阴阳、动静、纳甲、六亲、六神、伏神、是否世/应；
卦名区域：本卦名、互卦名、变卦名；
时空信息：公/农历、干支、月建、日辰、旬空。
导出与分享
导出：JSON（含全部结构化字段）、图片（带水印可选）、PDF。
分享：复制链接（含参数）、保存模板。
配置项
六神排法：随日轮转/固定起点可选；
纳甲体系：默认京房纳甲；
世应定位：按用宫取世（默认主流规则，详见算法）；
时区/历法：本地时区/指定时区，平气/定气可选（默认定气）。
神煞开关、显示精简模式。
四、核心算法规则说明

干支与月建/日辰
将公历时间转农历与干支： a. 使用万年历算法得到年/月/日/时的天干地支； b. 月建取当月地支，日辰取当日干支。
旬空：按日干支所属旬（甲子至癸亥每十天为一旬）求两个空地支。
纳甲与卦爻五行
八卦纳支（京房纳甲简述）： 乾纳戌亥（金），兑纳酉（金），离纳巳午（火），震纳卯（木），巽纳辰巳（木），坎纳子（水），艮纳丑寅（土），坤纳未申（土）；
六爻自下而上依卦象分配地支，得每爻的地支与所含五行。
世应定位（按宫位定世应）
算法直接取对照表：
读取 八宫六十四卦完整对照表.md中内容。

六亲判定
原则：卦宫所属五行为我：
同我同类为兄弟；
我生为子孙；
克我为官鬼；
我克为妻财；
生我为父母。
具体步骤： a. 求日干五行； b. 每爻取纳支五行； c. 对照生克关系映射得到六亲。
或读取八宫六十四卦完整对照表.md中内容。

六神排布
日干相关法：以当日的天干为起点，将六神依序配六爻（自下而上）如甲乙天干，初爻青龙；丙丁天干，初爻朱雀；戊天干，初爻勾陈；己天干初爻腾蛇；庚辛天干，初爻白虎；壬癸天干，初爻玄武；其他依次向上循环顺排，顺序如下：
六神顺序：青龙、朱雀、勾陈、腾蛇、白虎、玄武，循环；

动爻与变卦
动爻输入后，该爻阴阳反转生成变卦；
多动爻全部反转；
若无动爻，变卦为空或同本卦。
互卦
取二、三、四爻做下卦，三、四、五爻做上卦，组成互卦。
伏神
当某爻位不具备所需六亲时，依据纳甲与地支藏干体系安伏神。常用规则：
以爻纳支的同宫或相冲/合的地支中择一藏干作为伏神映射；
若有动变导致本位不全时，优先以对宫或三合中配伏；
实现需基于预置“伏神表”，确保与主流盘一致。

神煞
旬空：按日干支所在旬，两个缺位地支即旬空；
驿马、桃花、天乙贵人等按常用对照表（读取神煞表.json）计算，标记至对应地支之爻。

六、UI与交互

起卦面板：三种模式切换；时间选择器支持公历/农历切换与时区；掷钱模拟器（抛三次硬币=一爻，连做六爻）；按时间起卦（换算为当时农历日期与时间计算）；指定卦（指定卦下有数字起卦，指定卦爻方式，卦爻有四种少阴老阴少阳老阳用符号表示）。
排盘展示：六爻竖列，支持精简/详细视图切换；点击爻位展开显示纳甲、六亲、六神、伏神、神煞。
复制/导出：一键复制JSON、导出PNG/PDF；支持深色模式。
错误提示：输入不合法、时间越界、参数冲突等。
七、校验与一致性

与至少两款主流线上排盘工具的结果比对（同时间与规则配置下：卦名、世应、六亲、六神、旬空一致）。
单元测试覆盖：
干支换算、月建/日辰；
64卦世应定位映射；
纳甲与六亲映射；
互卦、变卦、伏神生成。
八、性能与可用性

本地计算，单次排盘<10ms（不含渲染）；
输出对无障碍阅读友好（ARIA标签），键盘可达；
国际化预留（中文为默认）。
九、安全与隐私

不上传用户占测内容至第三方，分享链接仅含必要参数并可手动清除个人备注。
十、测试用例（可复现）
用例1：时间起卦（默认设置）

输入：
模式：时间起卦
时间：2025-11-08 15:20:00（UTC+8）
预期步骤与关键结果：
干支换算（示例，具体以实现万年历为准）：
年干支：乙巳（示例）
月干支：庚戌（定气法，示例）
日干支：甲子（示例）
时干支：丙申（示例）
月建：戌；旬空：按甲子旬为空戌亥
起卦方式：时间起卦规则选型：
若采用“时间数理取卦”（可配置），通过年月日时转换为上、下卦与动爻；为测试一致性，此处固定预设结果：本卦为水天需（坎上乾下），动爻在二、五爻
排盘核心结果（示例，验证字段齐备，不以数值正确性为准）：
本卦：水天需；世在四，应在一（按坤宫映射，以预置表为准）
六神（Mode A）：初爻青龙，二朱雀，三勾陈，四腾蛇，五白虎，上玄武
六亲：按日干相关法生成，逐爻可见兄弟/子孙/妻财/官鬼/父母
动爻：二、五动；变卦自动生成；互卦自动生成
伏神：依据伏神表在缺位处标注
神煞：显示旬空为戌、亥；其他按对照表
导出验证：
JSON中包含 baseHex/mutualHex/changedHex/ganzhi/monthJian/riChen/xunKong 等字段
验收要点：
字段完整性、类型正确性；
世应位置与预置映射一致；
六神顺序正确；
动爻触发变卦正确；
互卦计算位置正确。
用例2：手动起卦（无动爻）

万年历/干支换算：引入权威可靠天文定气法；
64卦到宫位与世应映射：使用静态映射表，测试应覆盖全表；
纳甲、六神、伏神、神煞：以表驱动，便于校正与替换；
结果比对工具：内置“对照模式”，可输入外部盘数据做差异高亮。
十二、验收标准

功能：三种起卦方式可用，排盘元素齐全；
准确：与两款主流排盘比对，100条样本中主要字段一致率≥98%；
稳定：边界输入不崩溃，错误提示清晰；
性能：单次排盘<10ms（中端设备）；
文档与测试：开发文档、字段字典、100%关键路径单测覆盖。


八宫六十四卦完整对照表.md如果不能直接应用，还有一个八宫六十四卦完整对照表.json，可直接引用。

所有引用表都在当前 project目录下.