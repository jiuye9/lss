<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>八字排盘 - 移动版</title>
    <style>
      /* =================== 天青色科技风变量 =================== */
      :root {
        /* 天青色系主色调 */
        --primary-color: #00b4db;
        --primary-light: #00d4ff;
        --primary-dark: #0083b0;
        --secondary-color: #00ffc6;
        --accent-color: #ff4081;
        --warning-color: #ffa726;
        --success-color: #66bb6a;

        /* 科技风背景 */
        --background: linear-gradient(
          135deg,
          #0c1445 0%,
          #1e3c72 30%,
          #2a5298 100%
        );
        --surface: rgba(0, 180, 219, 0.05);
        --surface-elevated: rgba(0, 180, 219, 0.1);
        --glass-bg: rgba(0, 180, 219, 0.08);
        --glass-border: rgba(0, 212, 255, 0.2);

        /* 文字颜色 */
        --text-primary: #ffffff;
        --text-secondary: #b3e5fc;
        --text-accent: #00d4ff;

        /* 边框和阴影 */
        --border: rgba(0, 212, 255, 0.3);
        --border-glow: 0 0 10px rgba(0, 180, 219, 0.5);
        --shadow: 0 4px 20px rgba(0, 180, 219, 0.2);
        --shadow-glow: 0 0 30px rgba(0, 180, 219, 0.4);

        /* 渐变 */
        --gradient-primary: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
        --gradient-accent: linear-gradient(135deg, #00ffc6 0%, #00b4db 100%);
        --gradient-card: linear-gradient(
          145deg,
          rgba(255, 255, 255, 0.05) 0%,
          rgba(0, 180, 219, 0.1) 100%
        );
        --gradient-glow: linear-gradient(
          135deg,
          #00d4ff 0%,
          #00b4db 50%,
          #00ffc6 100%
        );

        /* 尺寸 */
        --radius: 12px;
        --radius-lg: 20px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      /* =================== 基础样式 =================== */
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC",
          "Hiragino Sans GB", sans-serif;
        background: var(--background);
        color: var(--text-primary);
        line-height: 1.5;
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
      }

      /* 科技风格背景网格 */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image:
          linear-gradient(rgba(0, 212, 255, 0.1) 1px, transparent 1px),
          linear-gradient(90deg, rgba(0, 212, 255, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
        mask: radial-gradient(circle, black 50%, transparent 70%);
        animation: gridMove 20s linear infinite;
        z-index: -1;
      }

      @keyframes gridMove {
        0% {
          transform: translate(0, 0);
        }
        100% {
          transform: translate(20px, 20px);
        }
      }

      /* 发光粒子效果 */
      body::after {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
          radial-gradient(
            circle at 20% 30%,
            rgba(0, 255, 198, 0.1) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(0, 180, 219, 0.1) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(0, 212, 255, 0.05) 0%,
            transparent 60%
          );
        animation: particleFloat 8s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes particleFloat {
        0%,
        100% {
          opacity: 0.5;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.1);
        }
      }

      .container {
        max-width: 100%;
        padding: 0;
        position: relative;
        z-index: 1;
      }

      /* =================== 顶部导航 =================== */
      .top-nav {
        background: var(--glass-bg);
        backdrop-filter: blur(20px);
        border-bottom: 1px solid var(--glass-border);
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow);
      }

      .nav-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-accent);
        text-shadow: var(--border-glow);
      }

      .nav-icon {
        width: 30px;
        height: 30px;
        background: var(--gradient-glow);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        box-shadow: var(--shadow-glow);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: var(--shadow-glow);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 40px rgba(0, 180, 219, 0.6);
        }
      }

      /* =================== 主要内容区 =================== */
      .main-content {
        padding: 20px 15px;
      }

      /* =================== 卡片组件 =================== */
      .card {
        background: var(--gradient-card);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow);
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--gradient-glow);
      }

      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-accent);
        margin: 0 0 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card-title::before {
        content: "◆";
        color: var(--secondary-color);
        text-shadow: var(--border-glow);
      }

      /* =================== 输入表单 =================== */
      .form-grid {
        display: grid;
        gap: 15px;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
      }

      .form-field {
        position: relative;
      }

      .form-field label {
        display: block;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-field input,
      .form-field select {
        width: 100%;
        padding: 12px 15px;
        background: rgba(0, 180, 219, 0.1);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        color: var(--text-primary);
        font-size: 1rem;
        transition: var(--transition);
      }

      .form-field input:focus,
      .form-field select:focus {
        outline: none;
        border-color: var(--primary-light);
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        background: rgba(0, 180, 219, 0.15);
      }

      /* =================== 开关组件 =================== */
      .switch-group {
        display: grid;
        gap: 12px;
        margin-top: 15px;
      }

      .switch-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 15px;
        background: rgba(0, 180, 219, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: var(--radius);
        transition: var(--transition);
      }

      .switch-item:active {
        transform: scale(0.98);
      }

      .switch-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
      }

      .switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        transition: var(--transition);
        cursor: pointer;
      }

      .switch.active {
        background: var(--gradient-accent);
        box-shadow: var(--border-glow);
      }

      .switch::before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .switch.active::before {
        transform: translateX(24px);
        background: var(--text-primary);
        box-shadow: 0 2px 8px rgba(0, 180, 219, 0.5);
      }

      /* =================== 按钮组件 =================== */
      .btn {
        width: 100%;
        padding: 16px 20px;
        background: var(--gradient-primary);
        border: none;
        border-radius: var(--radius-lg);
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow), var(--border-glow);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: var(--transition);
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn.loading::before {
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: rgba(0, 180, 219, 0.2);
        border: 1px solid var(--border);
        color: var(--text-accent);
      }

      /* =================== 结果显示 =================== */
      .result-section {
        display: none;
        animation: slideIn 0.5s ease-out;
      }

      .result-section.show {
        display: block;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* =================== 八字卡片网格 =================== */
      .bazi-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 20px 0;
      }

      .pillar-card {
        background: var(--gradient-card);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius);
        padding: 20px 15px;
        text-align: center;
        position: relative;
        overflow: hidden;
        transition: var(--transition);
      }

      .pillar-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        border-radius: var(--radius) var(--radius) 0 0;
      }

      .pillar-card:nth-child(1)::before {
        background: var(--gradient-accent);
      }
      .pillar-card:nth-child(2)::before {
        background: var(--gradient-primary);
      }
      .pillar-card:nth-child(3)::before {
        background: var(--gradient-glow);
      }
      .pillar-card:nth-child(4)::before {
        background: linear-gradient(135deg, #ff4081, #00d4ff);
      }

      .pillar-title {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .pillar-ganZhi {
        font-size: 2rem;
        font-weight: 900;
        color: var(--text-accent);
        margin: 10px 0;
        text-shadow: var(--border-glow);
        line-height: 1;
      }

      .pillar-details {
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .pillar-card:active {
        transform: scale(0.95);
      }

      /* =================== 详细表格 =================== */
      .detail-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: var(--surface);
        border-radius: var(--radius);
        overflow: hidden;
        box-shadow: var(--shadow);
        margin: 20px 0;
      }

      .detail-table th {
        background: var(--gradient-primary);
        color: white;
        padding: 12px 8px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .detail-table td {
        padding: 12px 8px;
        text-align: center;
        border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        font-size: 0.9rem;
        color: var(--text-primary);
      }

      .detail-table tbody tr:nth-child(1) td:nth-child(2) {
        color: var(--secondary-color);
        font-weight: 700;
        font-size: 1.1rem;
      }
      .detail-table tbody tr:nth-child(2) td:nth-child(2) {
        color: var(--primary-light);
        font-weight: 700;
        font-size: 1.1rem;
      }
      .detail-table tbody tr:nth-child(3) td:nth-child(2) {
        color: var(--text-accent);
        font-weight: 700;
        font-size: 1.1rem;
      }
      .detail-table tbody tr:nth-child(4) td:nth-child(2) {
        color: var(--accent-color);
        font-weight: 700;
        font-size: 1.1rem;
      }

      .detail-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* =================== 技术信息 =================== */
      .tech-info {
        background: rgba(0, 180, 219, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: var(--radius);
        padding: 15px;
        margin: 20px 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .tech-info h4 {
        margin: 0 0 10px 0;
        color: var(--text-accent);
        font-size: 1rem;
      }

      .tech-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(0, 212, 255, 0.1);
      }

      .tech-row:last-child {
        border-bottom: none;
      }

      .tech-label {
        color: var(--text-secondary);
      }

      .tech-value {
        color: var(--text-accent);
        font-family: monospace;
        font-size: 0.8rem;
      }

      /* =================== 通知组件 =================== */
      .notification {
        position: fixed;
        top: 80px;
        left: 15px;
        right: 15px;
        background: var(--gradient-card);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius);
        padding: 15px;
        transform: translateY(-100px);
        opacity: 0;
        transition: var(--transition);
        z-index: 1000;
        box-shadow: var(--shadow-glow);
      }

      .notification.show {
        transform: translateY(0);
        opacity: 1;
      }

      .notification.success {
        border-left: 4px solid var(--success-color);
      }
      .notification.warning {
        border-left: 4px solid var(--warning-color);
      }
      .notification.error {
        border-left: 4px solid var(--accent-color);
      }

      /* =================== 加载动画 =================== */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(12, 20, 69, 0.9);
        backdrop-filter: blur(10px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .loading-overlay.show {
        display: flex;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 3px solid rgba(0, 212, 255, 0.2);
        border-top: 3px solid var(--primary-light);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* =================== 底部安全区 =================== */
      .bottom-safe {
        height: env(safe-area-inset-bottom);
        background: var(--surface);
      }

      /* =================== 响应式优化 =================== */
      @media (max-width: 360px) {
        .main-content {
          padding: 15px 10px;
        }

        .card {
          padding: 15px;
        }

        .pillar-ganZhi {
          font-size: 1.8rem;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }

      /* =================== 暗色主题适配 =================== */
      @media (prefers-color-scheme: dark) {
        :root {
          --background: linear-gradient(
            135deg,
            #0a0e27 0%,
            #16213e 30%,
            #1a365d 100%
          );
        }
      }

      /* =================== 横屏适配 =================== */
      @media (orientation: landscape) and (max-height: 500px) {
        .bazi-grid {
          grid-template-columns: repeat(4, 1fr);
          gap: 10px;
        }

        .pillar-card {
          padding: 15px 10px;
        }

        .pillar-ganZhi {
          font-size: 1.5rem;
        }
      }
    </style>
  </head>

  <body>
    <!-- 顶部导航 -->
    <div class="top-nav">
      <div class="nav-content">
        <div class="nav-title">八字排盘</div>
        <div class="nav-icon">八</div>
      </div>
    </div>

    <div class="container">
      <div class="main-content">
        <!-- 输入表单卡片 -->
        <div class="card">
          <div class="card-title">出生信息</div>
          <div class="form-grid">
            <div class="form-row">
              <div class="form-field">
                <label>年</label>
                <input
                  type="number"
                  id="year"
                  value="1985"
                  min="1900"
                  max="2100"
                />
              </div>
              <div class="form-field">
                <label>月</label>
                <select id="month">
                  <option value="1">1月</option>
                  <option value="2">2月</option>
                  <option value="3">3月</option>
                  <option value="4" selected>4月</option>
                  <option value="5">5月</option>
                  <option value="6">6月</option>
                  <option value="7">7月</option>
                  <option value="8">8月</option>
                  <option value="9">9月</option>
                  <option value="10">10月</option>
                  <option value="11">11月</option>
                  <option value="12">12月</option>
                </select>
              </div>
              <div class="form-field">
                <label>日</label>
                <input type="number" id="day" value="7" min="1" max="31" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label>时</label>
                <input type="number" id="hour" value="10" min="0" max="23" />
              </div>
              <div class="form-field">
                <label>分</label>
                <input type="number" id="minute" value="0" min="0" max="59" />
              </div>
              <div class="form-field">
                <label>秒</label>
                <input type="number" id="second" value="0" min="0" max="59" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label>时区</label>
                <select id="timezone">
                  <option value="+08:00" selected>UTC+8:00 (北京)</option>
                  <option value="+09:00">UTC+9:00 (日本)</option>
                  <option value="+07:00">UTC+7:00 (泰国)</option>
                  <option value="±00:00">UTC±0:00 (格林)</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-field">
                <label>经度</label>
                <input
                  type="number"
                  id="longitude"
                  value="116.40"
                  step="0.01"
                  min="-180"
                  max="180"
                />
              </div>
              <div class="form-field">
                <label>纬度</label>
                <input
                  type="number"
                  id="latitude"
                  value="39.90"
                  step="0.01"
                  min="-90"
                  max="90"
                />
              </div>
            </div>
          </div>

          <!-- 选项开关 -->
          <div class="switch-group">
            <div class="switch-item">
              <div class="switch-label">真太阳时（仅时柱）</div>
              <div class="switch" id="solarTimeSwitch"></div>
            </div>
            <div class="switch-item">
              <div class="switch-label">子初交日（23:00）</div>
              <div class="switch active" id="zi23Switch"></div>
            </div>
            <div class="switch-item">
              <div class="switch-label">显示技术详情</div>
              <div class="switch active" id="detailsSwitch"></div>
            </div>
          </div>

          <!-- 计算按钮 -->
          <button class="btn" id="calculateBtn">开始排盘</button>
        </div>

        <!-- 结果显示区域 -->
        <div class="result-section" id="resultSection">
          <!-- 八字卡片 -->
          <div class="card">
            <div class="card-title">四柱八字</div>
            <div class="bazi-grid">
              <div class="pillar-card">
                <div class="pillar-title">年柱</div>
                <div class="pillar-ganZhi" id="yearPillar">--</div>
                <div class="pillar-details" id="yearDetails">--</div>
              </div>
              <div class="pillar-card">
                <div class="pillar-title">月柱</div>
                <div class="pillar-ganZhi" id="monthPillar">--</div>
                <div class="pillar-details" id="monthDetails">--</div>
              </div>
              <div class="pillar-card">
                <div class="pillar-title">日柱</div>
                <div class="pillar-ganZhi" id="dayPillar">--</div>
                <div class="pillar-details" id="dayDetails">日主</div>
              </div>
              <div class="pillar-card">
                <div class="pillar-title">时柱</div>
                <div class="pillar-ganZhi" id="hourPillar">--</div>
                <div class="pillar-details" id="hourDetails">--</div>
              </div>
            </div>
          </div>

          <!-- 详细表格 -->
          <div class="card">
            <div class="card-title">详细信息</div>
            <table class="detail-table">
              <thead>
                <tr>
                  <th>柱位</th>
                  <th>干支</th>
                  <th>十神</th>
                  <th>五行</th>
                  <th>阴阳</th>
                  <th>纳音</th>
                </tr>
              </thead>
              <tbody id="detailTableBody"></tbody>
            </table>
          </div>

          <!-- 技术信息 -->
          <div class="tech-info" id="techInfo" style="display: none">
            <h4>计算详情</h4>
            <div id="techDetails"></div>
          </div>
        </div>
      </div>

      <div class="bottom-safe"></div>
    </div>

    <!-- 通知组件 -->
    <div class="notification" id="notification"></div>

    <!-- 加载覆盖层 -->
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
    </div>

    <script>
      // ================== 常量定义 ==================
      const STEMS = [
        "甲",
        "乙",
        "丙",
        "丁",
        "戊",
        "己",
        "庚",
        "辛",
        "壬",
        "癸",
      ];
      const BRANCHES = [
        "子",
        "丑",
        "寅",
        "卯",
        "辰",
        "巳",
        "午",
        "未",
        "申",
        "酉",
        "戌",
        "亥",
      ];
      const STEM_ELEMENTS = [
        "木",
        "木",
        "火",
        "火",
        "土",
        "土",
        "金",
        "金",
        "水",
        "水",
      ];
      const STEM_YINYANG = [
        "阳",
        "阴",
        "阳",
        "阴",
        "阳",
        "阴",
        "阳",
        "阴",
        "阳",
        "阴",
      ];
      const NAYIN_60 = [
        "海中金",
        "海中金",
        "炉中火",
        "炉中火",
        "大林木",
        "大林木",
        "路旁土",
        "路旁土",
        "剑锋金",
        "剑锋金",
        "山头火",
        "山头火",
        "涧下水",
        "涧下水",
        "城头土",
        "城头土",
        "白腊金",
        "白腊金",
        "杨柳木",
        "杨柳木",
        "井泉水",
        "井泉水",
        "屋上土",
        "屋上土",
        "霹雳火",
        "霹雳火",
        "松柏木",
        "松柏木",
        "长流水",
        "长流水",
        "沙中金",
        "沙中金",
        "山下火",
        "山下火",
        "平地木",
        "平地木",
        "壁上土",
        "壁上土",
        "金箔金",
        "金箔金",
        "覆灯火",
        "覆灯火",
        "天河水",
        "天河水",
        "大驿土",
        "大驿土",
        "钗钏金",
        "钗钏金",
        "桑柘木",
        "桑柘木",
        "大溪水",
        "大溪水",
        "沙中土",
        "沙中土",
        "天上火",
        "天上火",
        "石榴木",
        "石榴木",
        "大海水",
        "大海水",
      ];

      // ================== 工具函数 ==================
      function parseTimezone(tzStr) {
        const match = tzStr.match(/^([+-])(\d{2}):(\d{2})$/);
        if (!match) return 0;
        const sign = match[1] === "-" ? -1 : 1;
        return sign * (parseInt(match[2]) + parseInt(match[3]) / 60);
      }

      function toJulianDay(year, month, day, hour) {
        let y = year,
          m = month;
        if (m <= 2) {
          y -= 1;
          m += 12;
        }
        const A = Math.floor(y / 100);
        const B = 2 - A + Math.floor(A / 4);
        const JD =
          Math.floor(365.25 * (y + 4716)) +
          Math.floor(30.6001 * (m + 1)) +
          day +
          B -
          1524.5;
        return JD + hour / 24;
      }

      function solarLongitude(jd) {
        const T = (jd - 2451545.0) / 36525;
        const L0 = (280.46646 + 36000.76983 * T + 0.0003032 * T * T) % 360;
        const M =
          ((357.52911 + 35999.05029 * T - 0.0001537 * T * T) * Math.PI) / 180;
        const C =
          (1.914602 - 0.004817 * T - 0.000014 * T * T) * Math.sin(M) +
          (0.019993 - 0.000101 * T) * Math.sin(2 * M) +
          0.000289 * Math.sin(3 * M);
        let L = L0 + C;
        return ((L % 360) + 360) % 360;
      }

      function findSolarLongitudeTime(year, targetDegree) {
        let jd = toJulianDay(year, 2, 4, 12);
        for (let i = 0; i < 15; i++) {
          const currentLongitude = solarLongitude(jd);
          const diff = ((targetDegree - currentLongitude + 540) % 360) - 180;
          if (Math.abs(diff) < 1e-6) break;
          jd += diff / 0.98564736;
        }
        return jd;
      }

      function indexToGanZhi(index) {
        return STEMS[index % 10] + BRANCHES[index % 12];
      }

      function ganZhiToIndex(ganZhi) {
        const gan = ganZhi[0];
        const zhi = ganZhi[1];
        const ganIndex = STEMS.indexOf(gan);
        const zhiIndex = BRANCHES.indexOf(zhi);

        for (let i = 0; i < 60; i++) {
          if (i % 10 === ganIndex && i % 12 === zhiIndex) {
            return i;
          }
        }
        return -1;
      }

      // ================== 八字计算函数 ==================
      function calculateYearPillar(jd, year) {
        const liChunJD = findSolarLongitudeTime(year, 315);
        const actualYear = jd >= liChunJD ? year : year - 1;
        const yearIndex = (actualYear - 1984 + 60) % 60;
        return {
          pillar: indexToGanZhi(yearIndex),
          actualYear: actualYear,
          liChunJD: liChunJD,
        };
      }

      function calculateMonthPillar(yearStemIndex, solarLong) {
        const monthIndex = Math.floor(((solarLong - 315 + 360) % 360) / 30);
        const branchIndex = (2 + monthIndex) % 12;
        const startStem = ((yearStemIndex % 5) * 2 + 2) % 10;
        const stemIndex = (startStem + monthIndex) % 10;

        return {
          pillar: STEMS[stemIndex] + BRANCHES[branchIndex],
          monthIndex: monthIndex,
          stemIndex: stemIndex,
        };
      }

      function calculateDayPillar(jdUTC, tzHours, useZi23) {
        let jdLocal = jdUTC + tzHours / 24;
        const localHour = (jdLocal + 0.5 - Math.floor(jdLocal + 0.5)) * 24;

        if (useZi23 && localHour >= 23) {
          jdLocal += 1 / 24;
        }

        const JDN = Math.floor(jdLocal + 0.5);
        const testJD = toJulianDay(1985, 4, 7, 12);
        const testGanZhiIndex = ganZhiToIndex("丙子");
        const daysDiff = Math.floor(JDN - Math.floor(testJD + 0.5));
        let dayIndex = (testGanZhiIndex + daysDiff) % 60;
        if (dayIndex < 0) dayIndex += 60;

        return {
          pillar: indexToGanZhi(dayIndex),
          dayIndex: dayIndex,
          JDN: JDN,
          localHour: localHour,
        };
      }

      function calculateHourPillar(
        jdUTC,
        tzHours,
        dayStemIndex,
        useSolarTime,
        longitude,
      ) {
        let jdLocal = jdUTC + tzHours / 24;
        let hour = (jdLocal + 0.5 - Math.floor(jdLocal + 0.5)) * 24;

        let solarCorr = 0;
        if (useSolarTime) {
          const lonCorr = ((longitude - 15 * tzHours) * 4) / 60;
          const T = (jdUTC - 2451545.0) / 36525;
          const L0 =
            ((280.46646 + 36000.76983 * T + 0.0003032 * T * T) * Math.PI) / 180;
          const M =
            ((357.52911 + 35999.05029 * T - 0.0001537 * T * T) * Math.PI) / 180;
          const e = 0.016708634 - 0.000042037 * T - 0.0000001267 * T * T;
          const E = 2 * e * Math.sin(M) + 1.25 * e * e * Math.sin(2 * M);
          const eot = ((Math.sin(2 * L0) - E) * 4) / 60;
          solarCorr = lonCorr + eot;
          hour = (hour + solarCorr + 24) % 24;
        }

        const branchIndex = Math.floor((hour + 1) / 2) % 12;
        const startStem = [0, 2, 4, 6, 8][dayStemIndex % 5];
        const stemIndex = (startStem + branchIndex) % 10;

        return {
          pillar: STEMS[stemIndex] + BRANCHES[branchIndex],
          hour: hour,
          solarCorr: solarCorr,
          stemIndex: stemIndex,
        };
      }

      function calculateTenGod(dayStemIndex, targetStemIndex) {
        const elements = ["木", "火", "土", "金", "水"];
        const restraint = { 木: "土", 土: "水", 水: "火", 火: "金", 金: "木" };

        const dayElement = STEM_ELEMENTS[dayStemIndex];
        const targetElement = STEM_ELEMENTS[targetStemIndex];
        const sameYinYang =
          STEM_YINYANG[dayStemIndex] === STEM_YINYANG[targetStemIndex];

        if (dayElement === targetElement) {
          return sameYinYang ? "比肩" : "劫财";
        }

        const dayIdx = elements.indexOf(dayElement);
        const targetIdx = elements.indexOf(targetElement);

        if ((targetIdx + 1) % 5 === dayIdx) {
          return sameYinYang ? "正印" : "偏印";
        }
        if ((dayIdx + 1) % 5 === targetIdx) {
          return sameYinYang ? "食神" : "伤官";
        }
        if (restraint[dayElement] === targetElement) {
          return sameYinYang ? "正财" : "偏财";
        }
        if (restraint[targetElement] === dayElement) {
          return sameYinYang ? "七杀" : "正官";
        }
        return "未知";
      }

      // ================== 主计算函数 ==================
      function calculateBazi() {
        const year = parseInt(document.getElementById("year").value);
        const month = parseInt(document.getElementById("month").value);
        const day = parseInt(document.getElementById("day").value);
        const hour = parseInt(document.getElementById("hour").value);
        const minute = parseInt(document.getElementById("minute").value);
        const second = parseInt(document.getElementById("second").value);
        const timezone = document.getElementById("timezone").value;
        const longitude = parseFloat(
          document.getElementById("longitude").value,
        );
        const useSolarTime = document
          .getElementById("solarTimeSwitch")
          .classList.contains("active");
        const useZi23 = document
          .getElementById("zi23Switch")
          .classList.contains("active");
        const showDetails = document
          .getElementById("detailsSwitch")
          .classList.contains("active");

        try {
          const tzHours = parseTimezone(timezone);
          const hourUTC = hour + minute / 60 + second / 3600 - tzHours;
          const jdUTC = toJulianDay(year, month, day, hourUTC);
          const solarLong = solarLongitude(jdUTC);

          const yearResult = calculateYearPillar(jdUTC, year);
          const yearStemIndex = STEMS.indexOf(yearResult.pillar[0]);

          const monthResult = calculateMonthPillar(yearStemIndex, solarLong);
          const monthStemIndex = STEMS.indexOf(monthResult.pillar[0]);

          const dayResult = calculateDayPillar(jdUTC, tzHours, useZi23);
          const dayStemIndex = STEMS.indexOf(dayResult.pillar[0]);

          const hourResult = calculateHourPillar(
            jdUTC,
            tzHours,
            dayStemIndex,
            useSolarTime,
            longitude,
          );
          const hourStemIndex = STEMS.indexOf(hourResult.pillar[0]);

          const yearGod = calculateTenGod(dayStemIndex, yearStemIndex);
          const monthGod = calculateTenGod(dayStemIndex, monthStemIndex);
          const hourGod = calculateTenGod(dayStemIndex, hourStemIndex);

          displayResults({
            year: yearResult,
            month: monthResult,
            day: dayResult,
            hour: hourResult,
            gods: { year: yearGod, month: monthGod, hour: hourGod },
            stemIndices: {
              year: yearStemIndex,
              month: monthStemIndex,
              day: dayStemIndex,
              hour: hourStemIndex,
            },
            calculation: {
              jdUTC: jdUTC,
              solarLong: solarLong,
              tzHours: tzHours,
              showDetails: showDetails,
            },
          });

          document.getElementById("resultSection").classList.add("show");
          showNotification("排盘计算完成！", "success");
        } catch (error) {
          showNotification("计算出错：" + error.message, "error");
          console.error("计算错误:", error);
        }
      }

      // ================== 结果显示 ==================
      function displayResults(result) {
        // 更新四柱卡片
        document.getElementById("yearPillar").textContent = result.year.pillar;
        document.getElementById("monthPillar").textContent =
          result.month.pillar;
        document.getElementById("dayPillar").textContent = result.day.pillar;
        document.getElementById("hourPillar").textContent = result.hour.pillar;

        document.getElementById("yearDetails").innerHTML =
          `${result.gods.year}<br>${STEM_ELEMENTS[result.stemIndices.year]}${STEM_YINYANG[result.stemIndices.year]}`;
        document.getElementById("monthDetails").innerHTML =
          `${result.gods.month}<br>${STEM_ELEMENTS[result.stemIndices.month]}${STEM_YINYANG[result.stemIndices.month]}`;
        document.getElementById("dayDetails").innerHTML =
          `日主<br>${STEM_ELEMENTS[result.stemIndices.day]}${STEM_YINYANG[result.stemIndices.day]}`;
        document.getElementById("hourDetails").innerHTML =
          `${result.gods.hour}<br>${STEM_ELEMENTS[result.stemIndices.hour]}${STEM_YINYANG[result.stemIndices.hour]}`;

        // 更新详细表格
        const tableBody = document.getElementById("detailTableBody");
        const pillars = [
          {
            name: "年柱",
            pillar: result.year.pillar,
            god: result.gods.year,
            stemIdx: result.stemIndices.year,
          },
          {
            name: "月柱",
            pillar: result.month.pillar,
            god: result.gods.month,
            stemIdx: result.stemIndices.month,
          },
          {
            name: "日柱",
            pillar: result.day.pillar,
            god: "日主",
            stemIdx: result.stemIndices.day,
          },
          {
            name: "时柱",
            pillar: result.hour.pillar,
            god: result.gods.hour,
            stemIdx: result.stemIndices.hour,
          },
        ];

        tableBody.innerHTML = "";
        pillars.forEach((p) => {
          const stemIdx = STEMS.indexOf(p.pillar[0]);
          const branchIdx = BRANCHES.indexOf(p.pillar[1]);
          // 正确的六十甲子索引计算
          let pillarIndex = -1;
          for (let i = 0; i < 60; i++) {
            if (i % 10 === stemIdx && i % 12 === branchIdx) {
              pillarIndex = i;
              break;
            }
          }
          const nayin = NAYIN_60[pillarIndex];
          const row = tableBody.insertRow();
          row.innerHTML = `
                    <td>${p.name}</td>
                    <td><strong>${p.pillar}</strong></td>
                    <td>${p.god}</td>
                    <td>${STEM_ELEMENTS[p.stemIdx]}</td>
                    <td>${STEM_YINYANG[p.stemIdx]}</td>
                    <td>${nayin}</td>
                `;
        });

        // 显示技术详情
        if (result.calculation.showDetails) {
          const techInfo = document.getElementById("techInfo");
          const techDetails = document.getElementById("techDetails");

          techDetails.innerHTML = `
                    <div class="tech-row">
                        <span class="tech-label">儒略日(UTC)</span>
                        <span class="tech-value">${result.calculation.jdUTC.toFixed(6)}</span>
                    </div>
                    <div class="tech-row">
                        <span class="tech-label">太阳黄经</span>
                        <span class="tech-value">${result.calculation.solarLong.toFixed(5)}°</span>
                    </div>
                    <div class="tech-row">
                        <span class="tech-label">时区偏移</span>
                        <span class="tech-value">UTC${result.calculation.tzHours >= 0 ? "+" : ""}${result.calculation.tzHours.toFixed(2)}</span>
                    </div>
                    <div class="tech-row">
                        <span class="tech-label">使用年份</span>
                        <span class="tech-value">${result.year.actualYear}年</span>
                    </div>
                `;

          techInfo.style.display = "block";
        } else {
          document.getElementById("techInfo").style.display = "none";
        }
      }

      // ================== UI 交互 ==================
      function showNotification(message, type) {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
          notification.classList.remove("show");
        }, 3000);
      }

      function showLoading() {
        document.getElementById("loadingOverlay").classList.add("show");
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").classList.remove("show");
      }

      // ================== 事件监听 ==================
      document.addEventListener("DOMContentLoaded", function () {
        // 计算按钮
        document
          .getElementById("calculateBtn")
          .addEventListener("click", function () {
            const btn = this;
            const originalText = btn.textContent;

            btn.textContent = "计算中...";
            btn.classList.add("loading");
            btn.disabled = true;
            showLoading();

            setTimeout(() => {
              calculateBazi();
              btn.textContent = originalText;
              btn.classList.remove("loading");
              btn.disabled = false;
              hideLoading();
            }, 1000);
          });

        // 开关切换
        document.querySelectorAll(".switch").forEach((switchEl) => {
          switchEl.addEventListener("click", function () {
            this.classList.toggle("active");
          });
        });

        // 自动计算（验证算法）
        setTimeout(() => {
          console.log("=== 验证1985年4月7日为丙子日 ===");
          const testJD = toJulianDay(1985, 4, 7, 12);
          const testResult = calculateDayPillar(testJD, 8, true);
          console.log(
            `计算结果: ${testResult.pillar}, 预期: 丙子, ${testResult.pillar === "丙子" ? "✓正确" : "✗错误"}`,
          );

          document.getElementById("calculateBtn").click();
        }, 500);
      });

      // 防止缩放
      document.addEventListener("gesturestart", function (e) {
        e.preventDefault();
      });

      document.addEventListener("touchstart", function (e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      });
    </script>
  </body>
</html>
